-- -*- mode: lua; coding: windows-1251-dos -*-
--схема удаления трупов сталкеров

function attach( sm )
  sm:subscribe({ signal = "on_before_spawn", fun = this.off_corpses })
end


local tabl_corpses      = {}
local tabl_corpses_9510 = {}
local exceptions_9510   = {
  -- трупики на Кордоне
  [   24 ] = true, -- esc_factory_prisoner_guard
  [  123 ] = true, -- gar_seryi_drug3
  -- трупики на Свалке
  [  101 ] = true, -- gar_dm_bandit_1
  [  102 ] = true, -- gar_dm_bandit_2
  [  103 ] = true, -- gar_dm_bandit_3
  [  106 ] = true, -- gar_bandit_agr_6
  [  109 ] = true, -- gar_wounded_bandit
  -- трупики в ТД
  [  401 ] = true, -- val_sacrifice_victim
  [  402 ] = true, -- val_prisoner_captive (Лохматый)
  [  404 ] = true, -- val_sacrifice_guard1
  [  405 ] = true, -- val_sacrifice_guard2
  [  407 ] = true, -- val_escort_guard1
  [  408 ] = true, -- val_escort_guard2
  [  409 ] = true, -- val_sacrifice_tunnel_bandit
  [  424 ] = true, -- Монгол
  [  519 ] = true, -- Барин в Баре
  [  703 ] = true, -- сумашедший на АС
  -- долговцы из группы Черепа и их противники свободовцы
  [  704 ] = true, -- снайпер на Базе Свободы
  [  708 ] = true,
  [  711 ] = true, -- mil_dolg_stalker0006_0000
  [  720 ] = true,
  [  721 ] = true,
  [  722 ] = true,
  [  725 ] = true, -- Угрюмый из кровососовки
  [  736 ] = true,
  [  737 ] = true,
  [  738 ] = true,
  [  740 ] = true,
  -- трупики на хуторе наемников
  [  710 ] = true, -- Павлик
  [  712 ] = true, -- mil_ara_guard3
  [  713 ] = true, -- mil_ara_guard2
  [  714 ] = true, -- mil_ara_guard1
  [  719 ] = true, -- mil_ara
  -- свободовцы в деревне кровососов, у костра
  [  726 ] = true,
  [  727 ] = true,
  -- трупики в Припяти
  [  806 ] = true, -- pri_followers_leader
  [  821 ] = true, -- pri_wave4_monolith5_free1
  -- трупики военных на ЧАЭС-1
  [ 1104 ] = true,
  [ 1105 ] = true,
  [ 1106 ] = true,
  -- трупики монолитовцев на Радаре
  [ 1071 ] = true,
  [ 1072 ] = true,
  [ 1073 ] = true,
  [ 1074 ] = true,
  [ 1075 ] = true,
  [ 1109 ] = true, -- какой-то военный на ЧАЭС-1
}

local exceptions_9510_info = {
  [    4 ] = { "esc_shustryi_medusa_done" }, -- Шустрый
  [    5 ] = { "esc_fox_medkit_done" }, -- Лис
  [    7 ] = { "mil_volk_resiver_done" }, -- Толик
  [    9 ] = { "esc_petruha_toz_done" }, -- Петруха
  [   92 ] = { "esc_find_groza_done" }, -- Проводник
  [   33 ] = { "esc_tutorial_dead_novice" }, -- труп у аномалии
  [  100 ] = { "val_pula_ammo_done", "seriy_helm", }, -- Серый
  -- Юрик
  [  104 ] = {
    "gar_dram_novice_mp5_m1_done",
    "gar_dram_novice_burer_hand_done",
  },
  -- труп на Свалке с МП-5 для Юрика
  [  124 ] = { "gar_dram_novice_mp5_m1_done" },
  [  302 ] = { "agr_krot_PDA_done" }, -- Крот
  [  422 ] = { "val_sos_give_info" }, -- Мессер
  [  437 ] = { "bar_darklab_document_done" }, -- труп с зарядами для РПГ в ТД
  [  450 ] = { "dar_password_info1" }, -- ученый с кодом двери в X-18
  [  451 ] = { "dar_password_info2" }, -- ученый с кодом двери в X-18
  [  724 ] = { "mil_fblockpost_quest_reward" }, -- Кэп
  [  903 ] = { "yan_find_vasilyev_end" }, -- труп Васильева около вертолета
  [  918 ] = { "yan_has_ghost_pda" }, -- труп отмычки Призрака в X-16
  -- военный с лечебным Бериллом на Янтаре
  [  922 ] = { "bar_deactivate_radar_done" },
  [ 9508 ] = { "bandit_krisyk_umer" }, -- Крысюк
}

--схема удаления трупов монстров
local tabl_monsters_dead = {} --все мёртвые монстры

--плюс схема удаления бесхозного оружия (если в названии предмета нет
--"grenade_" или "wpn_" - то это не считается оружием и убираться не
--будет !!!)
local tabl_weapons = {}

local always_remove = {
  [ "gl_fake_missile" ] = true,
  [ "gl_fake_missile_ammo_m209"    ] = true,
  [ "gl_fake_missile_ammo_vog-25"  ] = true,
  [ "gl_fake_missile_ammo_vog-25p" ] = true,
  [ "gl_test_shell"   ] = true,
  [ "gl_test_shell_ammo_m209"    ] = true,
  [ "gl_test_shell_ammo_vog-25"  ] = true,
  [ "gl_test_shell_ammo_vog-25p" ] = true,
}


local parent_keep_items = {}
function off_corpses()
  meceniy_outfit.is_pleer = false

  for _, gr in ipairs( xrs_grenade.gr_types ) do
    always_remove[ gr .. "_test" ] = true
    always_remove[ gr .. "_fake" ] = true
  end

  -- главный цикл
  local actor_level           = level.name()
  local dead_monster_on_level = {}
  local has_item              = {}
  for a = 1, 65534 do
    local obj = alife():object( a )
    if obj then
      local obj_level = object_level_name( obj )
      local obj_name  = obj:name()
      local obj_sect  = obj:section_name()

      if always_remove[ obj_sect ] then
        table.insert( tabl_monsters_dead, obj )

      elseif obj_sect == "psy_dog_phantom" or obj_sect == "m_phantom" then
        log2(
          "[%s]: found %s on %s",
          script_name(), obj_name, tostring( obj_level )
        )
        table.insert( tabl_monsters_dead, obj )

      -- сталкер
      elseif IsStalker( obj ) then
        if obj_level ~= actor_level and not obj:alive() then
          -- проверка трупа сталкера, если не в исключениях - в
          -- таблицу и бум удалять
          protected_items.unprotect_tabl_corps_keep( obj )
          add_9510_exceptions( obj )
          if
            not protected_items.is_corps_keep_by_story_id( obj )
            and not sak.can_be_resurrected( obj )
            and not protected_items.obj_is_protected(
              obj, "tabl_corps_keep", "exactly"
            )
          then
            if
              obj.m_story_id > 9510 or exceptions_9510[ obj.m_story_id ]
            then
              table.insert( tabl_corpses, obj )
            else
              -- эти трупы пысовские - не удаляются
              table.insert( tabl_corpses_9510, obj )
            end
          end
        end

      -- монстр
      elseif IsMonster( obj ) then
        -- труп
        if not obj:alive() then
          if obj_level == actor_level then
            dead_monster_on_level[ obj.id ] = obj
          else
            table.insert( tabl_monsters_dead, obj )
          end
        end

      else
        -- валяется на земле
        if obj.parent_id == 65535 then
          -- оружие
          if
            (
              string.find( obj_sect, "wpn_", 1, true )
              or string.find( obj_sect, "grenade_", 1, true )
            )
            and obj_level ~= actor_level
            and not protected_items.obj_is_protected(
              obj, "tabl_wpn_keep", "like"
            )
          then
            table.insert( tabl_weapons, obj )
          elseif obj_sect == "mutant_crow" then
            -- трупы ворон
            table.insert( tabl_monsters_dead, obj )
          elseif string.find( obj_sect, "af_", 1, true ) then
            local level_vertexes = amk_anoms.level_vertexes[ obj_level ]
            if obj.m_level_vertex_id > level_vertexes then
              log2(
                "[%s]: found %s on %s: wrong level_vertex: %s > %s",
                script_name(), obj_name, obj_level,
                obj.m_level_vertex_id, level_vertexes
              )
              table.insert( tabl_monsters_dead, obj )
            end
          elseif
            get_bool( obj_sect, "monster_part", false )
            and not item_keep( obj )
          then
              table.insert( tabl_monsters_dead, obj )
          end
        else
          -- в инвентаре
          has_item[ obj.parent_id ] = true
          if not parent_keep_items[ obj.parent_id ] and item_keep( obj ) then
            parent_keep_items[ obj.parent_id ] = true
          end
        end
      end

      -- фикс кривых smart_terrain
      if ( IsStalker( obj ) or IsMonster( obj ) ) and obj:alive() then
        local strn_id = obj:smart_terrain_id()
        if strn_id ~= 65535 then
          local strn = alife():object( strn_id )
          if strn and strn:clsid() ~= clsid.smart_terrain then
            log2(
              "[%s]: Обнаружена привязка к несуществующему smart_terrain: %s, smart_terrain_id: %s. Привязка удалена.",
              script_name(), obj_name, tostring( strn_id )
            )
            obj:clear_smart_terrain()
          end
        end
      end
    end
  end -- for

  -- зачистка мёртвых монстров
  for _, corps in ipairs( tabl_monsters_dead ) do
    if not parent_keep_items[ corps.id ] then
      alife():release( corps, true )
    end
  end
  
  -- удаление мертвых мутантов с пустым инвентарем на текущей локации
  for id, sobj in pairs( dead_monster_on_level ) do
    if not has_item[ id ] then
      alife():release( sobj, true )
    end
  end

  -- зачистка мёртвых человеков
  for _, corps in ipairs( tabl_corpses ) do
    if not parent_keep_items[ corps.id ] then
      alife():release( corps, true )
    end
  end

  --зачистка оружия
  for _, wpn in ipairs( tabl_weapons ) do
    alife():release( wpn, true )
  end
end


local cached_item = {}
function item_keep( item )
  -- проверка на предметы, тела с которыми нужно оставить
  local sect = item:section_name()
  if cached_item[ sect ] == nil then
    cached_item[ sect ] =
      get_bool( sect, "quest_item", false )
      or get_bool( sect, "watcher_act.bad_item", false )
      or protected_items.obj_is_protected( item, "tabl_items_keep", "like" )
      or protected_items.is_unique_wpn_keep( sect )
      or protected_items.obj_is_protected( item, "tabl_wpn_keep", "like" )
  end
  return cached_item[ sect ]
end


function add_9510_exceptions( sobj )
  local by_info = exceptions_9510_info[ sobj.m_story_id ]
  if by_info and sak.has_all_info( by_info ) then
    exceptions_9510[ sobj.m_story_id ] = true
  end
end
